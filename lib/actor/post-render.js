'use strict';

var each = require('../inc/utils').each;

/*
    Check all Actions for `onEnd`, return true if all are true

    @param [Actor]
    @param [boolean]
    @returns [boolean]
*/
var checkAllActionsHaveEnded = function checkAllActionsHaveEnded(actor, hasChanged) {
    var hasEnded = true;
    var values = actor.state.values;

    each(actor.activeActions, function (key, action) {
        // Return if action has been deleted elsewhere
        if (!action) {
            return;
        }

        if (action.onFrame) {
            action.onFrame.call(actor, values, actor, action);
        }

        if (action.onUpdate && hasChanged) {
            action.onUpdate.call(actor, values, actor, action);
        }

        if (action.hasEnded && action.hasEnded(actor, hasChanged) === false) {
            hasEnded = false;
        } else {
            if (action.onComplete) {
                action.onComplete.call(actor, actor, action);
            }
            actor.unbindAction(key);
        }
    });

    return hasEnded;
};

module.exports = function (actor, framestamp) {
    if (actor.isActive) {
        actor.isActive = false;

        if (checkAllActionsHaveEnded(actor, actor.hasChanged)) {
            var numRoles = actor.roles.length;

            // Fire `complete` callbacks
            for (var i = 0; i < numRoles; i++) {
                var role = actor.roles[i];
                if (role.complete) {
                    role.complete.call(actor, actor);
                }
            }

            if (!actor.isActive) {
                actor.next();
            }
        } else {
            actor.isActive = true;
            actor.firstFrame = false;
        }
    }

    actor.framestamp = framestamp;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY3Rvci9wb3N0LXJlbmRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJOzs7Ozs7Ozs7QUFBQyxBQVMxQyxJQUFNLHdCQUF3QixHQUFHLFNBQTNCLHdCQUF3QixDQUFJLEtBQUssRUFBRSxVQUFVLEVBQUs7QUFDcEQsUUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ3BCLFFBQUksTUFBTSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDOztBQUVoQyxRQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxVQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUs7O0FBRXZDLFlBQUksQ0FBQyxNQUFNLEVBQUU7QUFBRSxtQkFBTztTQUFFOztBQUV4QixZQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7QUFDaEIsa0JBQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ3JEOztBQUVELFlBQUksTUFBTSxDQUFDLFFBQVEsSUFBSSxVQUFVLEVBQUU7QUFDL0Isa0JBQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ3REOztBQUVELFlBQUksTUFBTSxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxVQUFVLENBQUMsS0FBSyxLQUFLLEVBQUU7QUFDakUsb0JBQVEsR0FBRyxLQUFLLENBQUM7U0FDcEIsTUFBTTtBQUNILGdCQUFJLE1BQU0sQ0FBQyxVQUFVLEVBQUU7QUFDbkIsc0JBQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDaEQ7QUFDRCxpQkFBSyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMzQjtLQUNKLENBQUMsQ0FBQzs7QUFFSCxXQUFPLFFBQVEsQ0FBQztDQUNuQixDQUFDOztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsVUFBQyxLQUFLLEVBQUUsVUFBVSxFQUFLO0FBQ3BDLFFBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtBQUNoQixhQUFLLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQzs7QUFFdkIsWUFBSSx3QkFBd0IsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFO0FBQ25ELGdCQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU07OztBQUFDLEFBR3BDLGlCQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQy9CLG9CQUFJLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzFCLG9CQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7QUFDZix3QkFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO2lCQUNwQzthQUNKOztBQUVELGdCQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRTtBQUNqQixxQkFBSyxDQUFDLElBQUksRUFBRSxDQUFDO2FBQ2hCO1NBQ0osTUFBTTtBQUNILGlCQUFLLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztBQUN0QixpQkFBSyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7U0FDNUI7S0FDSjs7QUFFRCxTQUFLLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztDQUNqQyxDQUFDIiwiZmlsZSI6InBvc3QtcmVuZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZWFjaCA9IHJlcXVpcmUoJy4uL2luYy91dGlscycpLmVhY2g7XG5cbi8qXG4gICAgQ2hlY2sgYWxsIEFjdGlvbnMgZm9yIGBvbkVuZGAsIHJldHVybiB0cnVlIGlmIGFsbCBhcmUgdHJ1ZVxuXG4gICAgQHBhcmFtIFtBY3Rvcl1cbiAgICBAcGFyYW0gW2Jvb2xlYW5dXG4gICAgQHJldHVybnMgW2Jvb2xlYW5dXG4qL1xuY29uc3QgY2hlY2tBbGxBY3Rpb25zSGF2ZUVuZGVkID0gKGFjdG9yLCBoYXNDaGFuZ2VkKSA9PiB7XG4gICAgbGV0IGhhc0VuZGVkID0gdHJ1ZTtcbiAgICBsZXQgdmFsdWVzID0gYWN0b3Iuc3RhdGUudmFsdWVzO1xuXG4gICAgZWFjaChhY3Rvci5hY3RpdmVBY3Rpb25zLCAoa2V5LCBhY3Rpb24pID0+IHtcbiAgICAgICAgLy8gUmV0dXJuIGlmIGFjdGlvbiBoYXMgYmVlbiBkZWxldGVkIGVsc2V3aGVyZVxuICAgICAgICBpZiAoIWFjdGlvbikgeyByZXR1cm47IH1cblxuICAgICAgICBpZiAoYWN0aW9uLm9uRnJhbWUpIHtcbiAgICAgICAgICAgIGFjdGlvbi5vbkZyYW1lLmNhbGwoYWN0b3IsIHZhbHVlcywgYWN0b3IsIGFjdGlvbik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYWN0aW9uLm9uVXBkYXRlICYmIGhhc0NoYW5nZWQpIHtcbiAgICAgICAgICAgIGFjdGlvbi5vblVwZGF0ZS5jYWxsKGFjdG9yLCB2YWx1ZXMsIGFjdG9yLCBhY3Rpb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFjdGlvbi5oYXNFbmRlZCAmJiBhY3Rpb24uaGFzRW5kZWQoYWN0b3IsIGhhc0NoYW5nZWQpID09PSBmYWxzZSkge1xuICAgICAgICAgICAgaGFzRW5kZWQgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChhY3Rpb24ub25Db21wbGV0ZSkge1xuICAgICAgICAgICAgICAgIGFjdGlvbi5vbkNvbXBsZXRlLmNhbGwoYWN0b3IsIGFjdG9yLCBhY3Rpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYWN0b3IudW5iaW5kQWN0aW9uKGtleSk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBoYXNFbmRlZDtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gKGFjdG9yLCBmcmFtZXN0YW1wKSA9PiB7XG4gICAgaWYgKGFjdG9yLmlzQWN0aXZlKSB7XG4gICAgICAgIGFjdG9yLmlzQWN0aXZlID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKGNoZWNrQWxsQWN0aW9uc0hhdmVFbmRlZChhY3RvciwgYWN0b3IuaGFzQ2hhbmdlZCkpIHtcbiAgICAgICAgICAgIGNvbnN0IG51bVJvbGVzID0gYWN0b3Iucm9sZXMubGVuZ3RoO1xuXG4gICAgICAgICAgICAvLyBGaXJlIGBjb21wbGV0ZWAgY2FsbGJhY2tzXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVJvbGVzOyBpKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgcm9sZSA9IGFjdG9yLnJvbGVzW2ldO1xuICAgICAgICAgICAgICAgIGlmIChyb2xlLmNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJvbGUuY29tcGxldGUuY2FsbChhY3RvciwgYWN0b3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFhY3Rvci5pc0FjdGl2ZSkge1xuICAgICAgICAgICAgICAgIGFjdG9yLm5leHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFjdG9yLmlzQWN0aXZlID0gdHJ1ZTtcbiAgICAgICAgICAgIGFjdG9yLmZpcnN0RnJhbWUgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAgICAgICAgIFxuICAgIGFjdG9yLmZyYW1lc3RhbXAgPSBmcmFtZXN0YW1wO1xufTsiXX0=